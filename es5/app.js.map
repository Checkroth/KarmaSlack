{"version":3,"sources":["app.js"],"names":[],"mappings":"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","file":"app.js","sourcesContent":["import { install as sourceMapSupportInstall } from 'source-map-support';\r\nimport Express from 'express';\r\nimport BodyParser from 'body-parser';\r\nimport Slack from 'slack-node';\r\n\r\nimport Config from '../es5/config.js'; \r\n\r\n\r\nimport KarmaModel from '../es5/karma.model.js'; \r\nimport ConfigModel from '../es5/config.model.js';\r\n \r\nimport MongooseService from '../es5/mongoose.service.js';\r\nimport KarmaService from '../es5/karma.service.js'; \r\nimport ConfigService from '../es5/config.service.js'; \r\n\r\nsourceMapSupportInstall();\r\n\r\nvar app = Express();\r\napp.use(BodyParser.urlencoded({ extended: true }));\r\n\r\nvar config = new Config();\r\n\r\nvar mongooseService = new MongooseService(config);\r\nmongooseService.init();\r\n\r\nvar karmaService = new KarmaService();\r\n\r\n\r\n//Karma commands\r\n/*\r\nkarmaService.add(\"111\", \"DAN\", \"Craigssss\").then((data)=>{\r\n\t\r\n\tconsole.log(data);\r\n\t\r\n\tkarmaService.remove(\"111\", \"DAN\", \"ccc\").then((data)=>{\r\n\r\n\t\tconsole.log(data);\r\n\r\n\t\tkarmaService.userCount(\"111\", \"DAN\")\r\n\t\t\t.then((data) => console.log(data));\r\n\t\t\t\r\n\t\tkarmaService.teamCount(\"111\")\r\n\t\t\t.then((data) => console.log(data));\r\n\t});\r\n});\r\n*/\r\n\r\n\r\n//Regsiter\r\n\r\nvar configService = new ConfigService();\r\n\r\n//karma: init https://hooks.slack.com/services/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\r\n\r\n\r\n/*\r\nvar configModel = new ConfigModel({\r\n\tteamId: \"12345\",\r\n\tteamDomain: \"dans teamss\",\r\n\tinboundWebhook: \"https://hooks.slack.com/services/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\",\r\n\toutboundToken: \"25LnEy4vXHEi88PlrLvg6htP\"\r\n});\r\n\r\nconfigService.register(configModel)\r\n\t.then((data) => console.log(data))\r\n\t.catch((data) => console.log(data));\r\n\r\n\r\nconfigService.register(\"12345\",\"dans teamss\",\"https://hooks.slack.com/services/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\")\r\n\t.then((data) => console.log(data))\r\n\t.catch((data) => console.log(data));\r\n*/\r\n\r\n\r\n\r\n\r\n//app.post('/test2',  (req, res) => {\r\n\t\r\n\r\n\t\r\n\t\r\n\t//KarmaModel.find({}).remove().exec();\r\n\t\r\n\t//KarmaModel.find({}).exec(function(err, collection){\r\n     /*   var promise = KarmaModel.create({\r\n\t\t\t  \"teamId\":\"111\",\r\n\t          \"userName\":\"DAN\",\r\n\t        },{\r\n\t\t\t  \"teamId\":\"111\",\r\n\t          \"userName\":\"DAN\",\r\n\t        },{\r\n\t\t\t  \"teamId\":\"111\",\r\n\t          \"userName\":\"BRETT\",\r\n        });\t\r\n\t\t\r\n\t\tpromise.then((err, karmas) => {\r\n\t\t  \tKarmaModel.points(\"111\",\"BRETT\", function(err, collection){\r\n\t\t\t\t//console.log('eeee: ' + collection.length);\r\n\t\t\t});\r\n\t\t});*/\r\n\t\t\t\r\n\t//});\r\n\t\r\n\r\n\r\n\r\n\t //res.send('Hello World!');\r\n\t\r\n//});\r\n\r\nfunction parseJson(str){\r\n\t\r\n\treturn new Promise((res,rej) =>{\r\n\t\t\r\n\t\ttry{\r\n\t\t\tres(JSON.parse(str));\r\n\t\t}catch(e){\r\n\t\t\trej();\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction authenticate(teamId, token){\r\n\t\t\r\n\treturn new Promise((res,rej)=>{\r\n\t\t\r\n\t\tlet configService = new ConfigService();\r\n\r\n\t\tconfigService.getConfig(teamId)\r\n\t\t\t.then((data) => {\r\n\r\n\t\t\t\tif(!data){\r\n\t\t\t\t\trej(\"No config found.\");\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif(token !== data.outboundToken){\r\n\t\t\t\t\trej(\"Invalid token.\");\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tres();\t\t\t\t\r\n\t\t\t}).catch((err)=>{\r\n\r\n\t\t\t\trej(err);\r\n\t\t\t});\r\n\t});\r\n}\r\n\r\napp.post('/karma',  (req, res) => {\r\n\t\r\n\t/*\r\n\tREQUEST\r\n\t\ttoken=XXXXXXXXXXXXXXXXXX\r\n\t\tteam_id=T0001\r\n\t\tteam_domain=example\r\n\t\tchannel_id=C2147483705\r\n\t\tchannel_name=test\r\n\t\ttimestamp=1355517523.000005\r\n\t\tuser_id=U2147483697\r\n\t\tuser_name=Steve\r\n\t\ttext=karma: <!everyone> ++\r\n\t\ttrigger_word=karma:\r\n\t*/\r\n\t\r\n\t//Needs to be a class\r\n\tvar slackData = {\r\n\t\ttoken: req.body.token,\r\n\t\tteamId: req.body.team_id,\r\n\t\tteamDomain: req.body.team_domain,\r\n\t\tchannelId: req.body.channel_id,\r\n\t\tchannelName: req.body.channel_name,\r\n\t\ttimestamp: req.body.timestamp,\r\n\t\tuserId: req.body.user_id,\r\n\t\tuserName: req.body.user_name,\r\n\t\toriginalText: req.body.text,\r\n\t\ttext: req.body.text.replace(req.body.trigger_word, '').trim(),\r\n\t\ttriggerWord: req.body.trigger_word\r\n\t};\r\n\t\r\n\tlet configService = new ConfigService();\r\n\t\r\n\tlet helpPattern = /(\\?)/g,\r\n\t\tinitPattern = /((init \\{)([\\s\\S]*)(\\}))/g,\r\n\t\tuserNamePattern = /<!(.*?)>/g,\r\n\t\tposPattern = /((<!)([a-z0-9]+)(> )(\\+\\+))/g,\r\n\t\tnegPattern = /((<!)([a-z0-9]+)(> )(\\-\\-))/g;\r\n\t\r\n\tlet slackResponse = \"Invalid Command. For help see; karma: ?\";\r\n\t\r\n\t//Help\r\n\r\n\tif(helpPattern.test(slackData.text)){\r\n\t\tslackResponse = \"How to use karma:\";\r\n\t\tslackResponse += \"\\n Positive karma = karma: @user ++\";\r\n\t\tslackResponse += \"\\n Negative karma = karma: @user --\";\r\n\t\tslackResponse += \"\\n User karma = karma: @user\";\r\n\t\tslackResponse += \"\\n Team karma = karma: team\";\r\n\t\tslackResponse += \"\\n Setup karma = karma: init {\";\r\n\t\tslackResponse += \"\\n  \\\"inboundWebhook\\\": \\\"https://hooks.slack.com/services/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\\\"\";\r\n\t\tslackResponse += \"\\n  \\\"outboundToken\\\": \\\"25LnEy4vXHEi88Plrpvg6htP\";\r\n\t\tslackResponse += \"\\n }\";\r\n\t\tres.send(slackResponse);\r\n\t}\r\n\t\r\n\t//Init\r\n\t\r\n\tif(initPattern.test(slackData.text)){\r\n\t\t\r\n\t\tvar jsonString = slackData.text.replace(\"init\", '').trim();\r\n\t\t\r\n\t\tparseJson(jsonString)\r\n\t\t\t.then((data)=>{\r\n\t\t\t\t\t\r\n\t\t\t\tlet configModel = new ConfigModel({\r\n\t\t\t\t\tteamId: slackData.teamId,\r\n\t\t\t\t\tteamDomain: slackData.teamDomain,\r\n\t\t\t\t\tinboundWebhook: data.inboundWebhook || '',\r\n\t\t\t\t\toutboundToken: data.outboundToken || ''\r\n\t\t\t\t});\r\n\r\n\t\t\t\tconfigService.register(configModel)\r\n\t\t\t\t\t.then((data) => {\r\n\t\t\t\t\t\tslackResponse = data;\r\n\t\t\t\t\t\tres.send(slackResponse);\r\n\t\t\t\t\t})\r\n\t\t\t\t\t.catch((data) => {\r\n\t\t\t\t\t\tslackResponse = data;\r\n\t\t\t\t\t\tres.send(slackResponse);\r\n\t\t\t\t\t});\r\n\t\t\t\t\t\r\n\t\t\t}).catch(()=>{\r\n\t\t\t\tslackResponse = \"Invalid init JSON. For help see; karma: ?\";\r\n\t\t\t\tres.send(slackResponse);\r\n\t\t\t});\r\n\t}\r\n\t\r\n\t//Positive karma\r\n\t\r\n\tif(posPattern.test(slackData.text)){\r\n\t\t\r\n\t\tauthenticate(slackData.teamId, slackData.token).then(()=>{\r\n\r\n\t\t\tvar userName = userNamePattern.exec(slackData.text)[1];\r\n\t\t\t\r\n\t\t\tkarmaService.add(slackData.teamId, userName, slackData.userName)\r\n\t\t\t\t.then((data)=>{\t\t\t\r\n\t\t\t\t\tres.send(data);\r\n\t\t\t\t});\r\n\t\t\t\t\r\n\t\t}).catch((err)=>{\r\n\t\t\t\r\n\t\t\tres.send(err);\r\n\t\t});\r\n\t}\r\n\t\r\n\t//Negative karma\r\n\t\r\n\tif(negPattern.test(slackData.text)){\r\n\t\t\r\n\t\tauthenticate(slackData.teamId, slackData.token).then(()=>{\r\n\r\n\t\t\tvar userName = userNamePattern.exec(slackData.text)[1];\r\n\t\t\t\r\n\t\t\tkarmaService.remove(slackData.teamId, userName, slackData.userName)\r\n\t\t\t\t.then((data)=>{\t\t\t\r\n\t\t\t\t\tres.send(data);\r\n\t\t\t\t});\r\n\t\t\t\t\r\n\t\t}).catch((err)=>{\r\n\t\t\t\r\n\t\t\tres.send(err);\r\n\t\t});\r\n\t}\r\n\t\r\n\t//Team Total\r\n\t\r\n\t/*\r\n\tvar channelName = req.body.channel_name;\r\n\tvar text = req.body.text;\r\n\t\r\n\t\r\n\t\r\n\t\r\n\t\r\n\t\r\n\t\r\n\tmongoose.connect(config.db);\r\n\t\r\n\tvar db = mongoose.connection;\r\n\t\r\n\tdb.on('error', console.error.bind(console, 'connection error...'));\r\n\tdb.once('open', function callback(){\r\n\t\tconsole.log('db opened');\r\n\t});\r\n\t\r\n\tContact.find({}).remove().exec();\r\n\t\r\n\tContact.find({}).exec(function(err, collection){\r\n\t        Contact.create({\r\n\t          \"name\":text,\r\n\t        });\t\r\n\t});\r\n\t\r\n\t*/\r\n\t\r\n\t\r\n\t\r\n\t\r\n\t\r\n\t/*\r\n\t\r\n\t\r\n\t//Test valid text value\r\n\t\r\n\t\r\n\r\n\t\r\n\t//var user = text.replace('karma:', '');\r\n\t\r\n\tvar slackRes = new Slack();\r\n\tslackRes.setWebhook(\"https://hooks.slack.com/services/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\");\r\n\t\r\n\tslackRes.webhook({\r\n\t  channel: \"#\" + channelName,\r\n\t  username: \"webhookbot\",\r\n\t  text: slackResponse + \"   |||||| \" + text\r\n\t}, (err, response) => {\r\n\t  console.log(response);\r\n\t});*/\r\n});\r\n//((karma: @)([a-z0-9]+ )(\\+\\+|\\-\\-))\r\napp.listen(config.port, \r\n\t() => console.log(`Running on port ${config.port}`));\r\n"],"sourceRoot":"D:\\Projects\\karma\\warm-sea-8289\\es6"}