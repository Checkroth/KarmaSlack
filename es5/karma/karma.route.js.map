{"version":3,"sources":["karma/karma.route.js"],"names":[],"mappings":"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","file":"karma/karma.route.js","sourcesContent":["import ConfigModel from '../config/config.model.js';\r\nimport KarmaRegex from '../core/karmaregex.js';\r\n\r\nexport default class KarmaRoute{\r\n\t\r\n\tconstructor(expressService, configService, slackService, karmaService) {\r\n\t\t\r\n\t\tthis._app = expressService.app;\r\n\t\tthis._configService = configService;\r\n\t\tthis._slackService = slackService;\r\n\t\tthis._karmaService = karmaService;\r\n\t\tthis._init();\r\n\t}\r\n\t\r\n\t_init(){\r\n\t\t\r\n\t\tthis._app.post('/karma',  (req, res) => {\r\n\t\r\n\t\t\t/*\r\n\t\t\tREQUEST\r\n\t\t\t\ttoken=XXXXXXXXXXXXXXXXXX\r\n\t\t\t\tteam_id=T0001\r\n\t\t\t\tteam_domain=example\r\n\t\t\t\tchannel_id=C2147483705\r\n\t\t\t\tchannel_name=test\r\n\t\t\t\ttimestamp=1355517523.000005\r\n\t\t\t\tuser_id=U2147483697\r\n\t\t\t\tuser_name=Steve\r\n\t\t\t\ttext=karma: <!everyone> ++\r\n\t\t\t\ttrigger_word=karma:\r\n\t\t\t*/\r\n\t\t\t\r\n\t\t\t//Needs to be a class\r\n\t\t\tlet slackData = {\r\n\t\t\t\ttoken: req.body.token,\r\n\t\t\t\tteamId: req.body.team_id,\r\n\t\t\t\tteamDomain: req.body.team_domain,\r\n\t\t\t\tchannelId: req.body.channel_id,\r\n\t\t\t\tchannelName: req.body.channel_name,\r\n\t\t\t\ttimestamp: req.body.timestamp,\r\n\t\t\t\tuserId: req.body.user_id,\r\n\t\t\t\tuserName: req.body.user_name,\r\n\t\t\t\toriginalText: req.body.text,\r\n\t\t\t\ttext: req.body.text.replace(req.body.trigger_word + ':', '').trim(),\r\n\t\t\t\ttriggerWord: req.body.trigger_word\r\n\t\t\t};\r\n\t\t\t\t\t\t\r\n\t\t\t//Help\r\n\t\t\r\n\t\t\tif(KarmaRegex.helpPattern.test(slackData.text)){\r\n\t\t\t\tthis._helpCommand(slackData, res);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t//Init\r\n\t\r\n\t\t\tif(KarmaRegex.initPattern.test(slackData.text)){\t\t\t\t\r\n\t\t\t\tthis._initCommand(slackData, res);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t//Positive karma\r\n\t\t\r\n\t\t\tif(KarmaRegex.posPattern.test(slackData.text)){\r\n\t\t\t\tthis._posCommand(slackData, res);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t//Negative karma\r\n\t\r\n\t\t\tif(KarmaRegex.negPattern.test(slackData.text)){\t\t\t\t\r\n\t\t\t\tthis._negCommand(slackData, res);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t//User Total\r\n\t\t\t\r\n\t\t\tif(KarmaRegex.userIdSinglePattern.test(slackData.text)){\r\n\t\t\t\tthis._userTotalCommand(slackData, res);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t//Team Total\r\n\t\t\t\r\n\t\t\tif(KarmaRegex.teamIdPattern.test(slackData.text)){\r\n\t\t\t\tthis._teamTotalCommand(slackData, res);\r\n\t\t\t}\r\n\t\t});\t\r\n\t}\r\n\t\r\n\t_helpCommand(slackData, res){\r\n\t\tlet slackResponse = \"How to use karma:\";\r\n\t\t\tslackResponse += `\\n Positive karma = ${slackData.triggerWord}: @user ++`;\r\n\t\t\tslackResponse += `\\n Negative karma = ${slackData.triggerWord}: @user --`;\r\n\t\t\tslackResponse += `\\n User karma = ${slackData.triggerWord}: @user`;\r\n\t\t\tslackResponse += `\\n Team karma = ${slackData.triggerWord}: @everyone`;\r\n\t\t\tslackResponse += `\\n Setup karma = ${slackData.triggerWord}: init {`;\r\n\t\t\tslackResponse += \"\\n  \\\"incomingWebhookUrl\\\": \\\"https://hooks.slack.com/services/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\\\",\";\r\n\t\t\tslackResponse += \"\\n  \\\"outgoingToken\\\": \\\"25LnEy4vXHEi88Plrpvg6htP\\\"\";\r\n\t\t\tslackResponse += \"\\n }\";\r\n\t\tthis._slackService.sendResponse(slackData, slackResponse, res);\r\n\t}\r\n\t\r\n\t_initCommand(slackData, res){\r\n\t\tlet configJsonString = slackData.text.replace(\"init\", '').trim();\r\n\t\t\r\n\t\tthis._slackService.parseJson(configJsonString)\r\n\t\t\t.then((data)=>{\r\n\r\n\t\t\t\t//Remove the '<>' from the inbound webhook that slack seems to add around urls.\r\n\t\t\t\tdata.incomingWebhookUrl = data.incomingWebhookUrl.replace(/<|>/g,'');\r\n\r\n\t\t\t\tlet configModel = new ConfigModel({\r\n\t\t\t\t\tteamId: slackData.teamId,\r\n\t\t\t\t\tteamDomain: slackData.teamDomain,\r\n\t\t\t\t\t//apiToken: data.apiToken || ''\r\n\t\t\t\t\tincomingWebhookUrl: data.incomingWebhookUrl || '',\r\n\t\t\t\t\toutgoingToken: data.outgoingToken || ''\t\t\t\t\t\r\n\t\t\t\t});\r\n\r\n\t\t\t\tthis._configService.register(configModel)\r\n\t\t\t\t\t.then((data) => {\r\n\r\n\t\t\t\t\t\tthis._slackService.sendResponse(slackData, data, res);\r\n\t\t\t\t\t})\r\n\t\t\t\t\t.catch((data) => {\r\n\r\n\t\t\t\t\t\tthis._slackService.sendResponse(slackData, data, res);\r\n\t\t\t\t\t});\r\n\t\t\t\t\t\r\n\t\t\t}).catch(()=>{\r\n\t\t\t\tthis._slackService.sendResponse(slackData, `Invalid init JSON. For help see; ${slackData.triggerWord}: ?`, res);\r\n\t\t\t});\r\n\t}\r\n\t\r\n\t_posCommand(slackData, res){\r\n\t\t\t\t\t\t\t\t\t\t\t\r\n\t\tthis._slackService.authenticate(slackData.teamId, slackData.token).then(()=>{\r\n\r\n\t\t\tlet userId = KarmaRegex.userIdPattern.exec(slackData.text)[1];\r\n\t\t\t\r\n\t\t\tthis._karmaService.add(slackData.teamId, userId, slackData.userId)\r\n\t\t\t\t.then((data)=>{\t\r\n\t\t\t\t\tthis._slackService.sendResponse(slackData, data, res);\r\n\t\t\t\t}).catch((err)=>{\t\r\n\t\t\t\t\tthis._slackService.sendResponse(slackData, err, res);\r\n\t\t\t\t});\r\n\t\t\t\t\r\n\t\t}).catch((err)=>{\t\t\t\r\n\t\t\tthis._slackService.sendResponse(slackData, err, res);\r\n\t\t});\r\n\t}\r\n\t\r\n\t_negCommand(slackData, res){\r\n\t\tthis._slackService.authenticate(slackData.teamId, slackData.token).then(()=>{\r\n\r\n\t\t\tlet userId = KarmaRegex.userIdPattern.exec(slackData.text)[1];\r\n\t\t\t\r\n\t\t\tthis._karmaService.remove(slackData.teamId, userId, slackData.userId)\r\n\t\t\t\t.then((data)=>{\t\t\t\r\n\t\t\t\t\tthis._slackService.sendResponse(slackData, data, res);\r\n\t\t\t\t});\r\n\t\t\t\t\r\n\t\t}).catch((err)=>{\t\t\t\r\n\t\t\tthis._slackService.sendResponse(slackData, err, res);\r\n\t\t});\r\n\t}\r\n\t\r\n\t_userTotalCommand(slackData, res){\r\n\t\tthis._slackService.authenticate(slackData.teamId, slackData.token).then(()=>{\r\n\t\t\t\r\n\t\t\tlet userId = KarmaRegex.userIdPattern.exec(slackData.text)[1];\r\n\t\t\t\r\n\t\t\tthis._karmaService.userCount(slackData.teamId, userId)\r\n\t\t\t\t.then((data)=>{\t\t\t\r\n\t\t\t\t\tthis._slackService.sendResponse(slackData, data, res);\r\n\t\t\t\t});\r\n\t\t\t\t\r\n\t\t}).catch((err)=>{\t\t\t\r\n\t\t\tthis._slackService.sendResponse(slackData, err, res);\r\n\t\t});\r\n\t}\r\n\t\r\n\t_teamTotalCommand(slackData, res){\r\n\t\tthis._slackService.authenticate(slackData.teamId, slackData.token).then(()=>{\r\n\t\t\t\r\n\t\t\tthis._karmaService.teamCount(slackData.teamId)\r\n\t\t\t\t.then((data)=>{\t\t\t\r\n\t\t\t\t\tthis._slackService.sendResponse(slackData, data, res);\r\n\t\t\t\t});\r\n\t\t\t\t\r\n\t\t}).catch((err)=>{\t\t\t\r\n\t\t\tthis._slackService.sendResponse(slackData, err, res);\r\n\t\t});\r\n\t}\r\n};"],"sourceRoot":"D:\\Projects\\karma\\warm-sea-8289\\es6"}